<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Cashier</title>
<link rel="manifest" href="manifest.json" />
<script>
var port = undefined;

(function() {
  // Setup initial communication bridge with TWA
  window.addEventListener("message", function (event) {
    port = event.ports[0];
    if (typeof port === 'undefined') return;

    console.log("[Bridge] Port received from native");

    // Send ON_PAGE_LOAD event
    port.postMessage(JSON.stringify({
      "eventName": "ON_PAGE_LOAD",
      "parameters": {
        "URL": "https://promo.nj.betmgm.com/en/promo/geolocator/sports?_nativeApp=sportsw&lang=en"
      }
    }));

    // Setup listener for incoming messages from native
    port.onmessage = function(event) {
      console.log("[Bridge] Received message from native:", event.data);
    };
  });
})();

// ðŸ”„ Lifecycle Callbacks from Web
document.addEventListener("visibilitychange", function() {
  if (!port) return;

  if (document.visibilityState === "hidden") {
    console.log("[Bridge] Page hidden â€” sending ON_PAGE_HIDDEN");
    port.postMessage(JSON.stringify({
      "eventName": "ON_PAGE_HIDDEN",
      "parameters": { "timestamp": Date.now() }
    }));
  } else if (document.visibilityState === "visible") {
    console.log("[Bridge] Page visible â€” sending ON_PAGE_VISIBLE");
    port.postMessage(JSON.stringify({
      "eventName": "ON_PAGE_VISIBLE",
      "parameters": { "timestamp": Date.now() }
    }));
  }
});

// ðŸ§¹ Handle page unload (TWA closed or reloaded)
window.addEventListener("beforeunload", function() {
  if (!port) return;
  console.log("[Bridge] Page unloading â€” sending ON_PAGE_UNLOAD");
  port.postMessage(JSON.stringify({
    "eventName": "ON_PAGE_UNLOAD",
    "parameters": { "timestamp": Date.now() }
  }));
});

// ðŸ’€ Handle final cleanup â€” ON_PAGE_DESTROY (similar to Android onDestroy)
window.addEventListener("unload", function() {
  if (!port) return;
  console.log("[Bridge] Page destroyed â€” sending ON_PAGE_DESTROY");
  port.postMessage(JSON.stringify({
    "eventName": "ON_PAGE_DESTROY",
    "parameters": { "timestamp": Date.now() }
  }));
});

// ðŸ§ª Demo manual triggers
function myFunction1() {
  if (!port) return;
  port.postMessage(JSON.stringify({
    "eventName": "ON_PAGE_LOAD1",
    "parameters": {
      "URL": "https://promo.nj.betmgm.com/en/promo/geolocator/sports?_nativeApp=sportsw&lang=en"
    }
  }));
}

function myFunction2() {
  window.parent.postMessage(JSON.stringify({
    "eventName": "ON_PAGE_LOAD2",
    "parameters": {
      "URL": "https://promo.nj.betmgm.com/en/promo/geolocator/sports?_nativeApp=sportsw&lang=en"
    }
  }));
}

function myFunction3() {
  window.postMessage(JSON.stringify({
    "eventName": "ON_PAGE_LOAD3",
    "parameters": {
      "URL": "https://promo.nj.betmgm.com/en/promo/geolocator/sports?_nativeApp=sportsw&lang=en"
    }
  }));
}
</script>
</head>

<body>
  <h2>BetMGM Communication Bridge</h2>
  <button onclick="myFunction1()">Click me 1</button>
  <button onclick="myFunction2()">Click me 2</button>
  <button onclick="myFunction3()">Click me 3</button>
  <input type="hidden" id="portValue" name="portValue" value="34657" />
</body>
</html>

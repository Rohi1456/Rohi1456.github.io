<!DOCTYPE html>
<html>
<head>
  <title>TWA PostMessage Demo</title>
  <meta charset="UTF-8" />
</head>
<body>
  <h1>TWA Bidirectional Messaging</h1>
  <button id="sendToApp">Send to Android App</button>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js')
        .then(reg => {
          console.log('SW registered:', reg);
          if (!navigator.serviceWorker.controller) {
            console.warn('No controller, reloading...');
            location.reload(); // required to activate controller
          }
        }).catch(err => console.error('SW registration failed:', err));
    }

    document.getElementById('sendToApp').addEventListener('click', () => {
      if (navigator.serviceWorker.controller) {
        const msg = 'Hello from Web!';
        const channel = new MessageChannel();

        channel.port1.onmessage = event => {
          console.log('Reply from Android or SW:', event.data);
          alert('Reply: ' + event.data);
        };

        navigator.serviceWorker.controller.postMessage(msg, [channel.port2]);
      } else {
        alert('Service Worker not ready. Please reload.');
      }
    });

    navigator.serviceWorker.addEventListener('message', event => {
      console.log('Message from Android (via SW):', event.data);
      alert('Android says: ' + event.data);
    });
  </script>
</body>
</html>

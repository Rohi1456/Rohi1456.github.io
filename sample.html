<!DOCTYPE html>
<html>
<head>
  <title>TWA Message Demo</title>
  <meta charset="UTF-8" />
</head>
<body>
  <h1>TWA PostMessage Demo</h1>
  <button id="sendToApp">Send to Android App</button>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js')
        .then(reg => {
          console.log('Service Worker registered:', reg);

          if (navigator.serviceWorker.controller) {
            console.log('Service worker controller found');
          } else {
            console.log('No controller yet. Page needs reload.');
          }
        })
        .catch(err => {
          console.error('Service Worker registration failed:', err);
        });
    }

    document.getElementById('sendToApp').addEventListener('click', () => {
      if (navigator.serviceWorker.controller) {
        const messageChannel = new MessageChannel();

        messageChannel.port1.onmessage = (event) => {
          console.log('Received from Android:', event.data);
          alert('Message from Android: ' + event.data);
        };

        navigator.serviceWorker.controller.postMessage(
          'Hello from Web!',
          [messageChannel.port2]
        );
      } else {
        alert('Service Worker not ready. Please reload the page.');
      }
    });

    // For postMessage from Android
    navigator.serviceWorker.addEventListener('message', event => {
      console.log('Message from Android App:', event.data);
      alert('Received from Android: ' + event.data);
    });
  </script>
</body>
</html>
